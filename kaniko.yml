.baseVariables:
  variables:
    REGISTRY_ENDPOINT: registry.gitlab.com/christiantragesser
    IMAGE_REGISTRY_APP: ${REGISTRY_ENDPOINT}/${IMAGE_NAME}
    IMAGE_COMMIT_TAG: ${CI_COMMIT_SHORT_SHA}

.setup: &kaniko-setup
  - mkdir -p /kaniko/.docker
  - |
    cat << EOF > /kaniko/.docker/config.json
    {
      "auths": {
        "$REGISTRY_ENDPOINT": {
          "auth": "$(echo -n $CI_REGISTRY_USER:$CI_REGISTRY_PASSWORD | base64)"
        }
      }
    }
    EOF

.executor: &kaniko-exec
    - /kaniko/executor
      --context $CI_PROJECT_DIR
      --dockerfile $IMAGE_FILE_PATH/Dockerfile
      --destination $IMAGE_REGISTRY_APP:$IMAGE_COMMIT_TAG
      --destination $IMAGE_REGISTRY_APP:latest
      --skip-unused-stages
      --target ${DOCKER_BUILD_STAGE}
      ${KANIKO_ADDITIONAL_ARGS}

.kaniko:
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  extends:
    - .baseVariables
  script:
    - *kaniko-setup
    - *kaniko-exec

